<%- include("partials/header", { title: (sorun && sorun.baslik) ? sorun.baslik + " - Engi-Log" : "Sorun Detayı - Engi-Log" }) %>

<style>
    .detail-header { margin-bottom: 2.5rem; }

    .detail-title {
        font-size: clamp(1.8rem, 4vw, 2.6rem);
        font-weight: 700;
        font-family: "JetBrains Mono", monospace;
        margin-bottom: .5rem;
    }

    .detail-meta {
        color: hsl(var(--color-text-muted));
        font-size: .9rem;
    }

    .detail-card {
        background: hsl(var(--color-surface));
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 2rem;
        margin-bottom: 3rem;
    }

    .detail-desc {
        font-size: 1rem;
        line-height: 1.8;
        margin-top: 1rem;
    }

    /* === ORTAK GÖRSEL STANDART === */
    .img-box {
        width: 100%;
        max-width: 420px;
        height: 240px;
        overflow: hidden;
        border-radius: 12px;
        margin-top: 1.5rem;
        cursor: pointer;
        border: 1px solid var(--border-light);
    }

    .img-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform .3s ease;
    }

    .img-box:hover img {
        transform: scale(1.06);
    }

    /* === ÇÖZÜM KART === */
    .solution-card {
        background: hsl(var(--color-surface-alt));
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .expert-badge {
        display: inline-block;
        margin-bottom: .6rem;
        padding: .3rem .6rem;
        font-size: .75rem;
        font-family: "JetBrains Mono", monospace;
        border-radius: 6px;
        background: hsl(var(--color-primary) / 0.12);
        color: hsl(var(--color-primary));
        border: 1px solid hsl(var(--color-primary) / 0.35);
    }

    .solution-empty {
        color: hsl(var(--color-text-muted));
        font-size: .95rem;
        margin-bottom: 1.5rem;
    }

    .back-link {
        display: inline-block;
        margin-top: 3rem;
        color: hsl(var(--color-secondary));
        text-decoration: none;
        font-size: .9rem;
    }

    .back-link:hover { text-decoration: underline; }

    /* === MODAL === */
    .img-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .img-modal img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 12px;
    }

    .img-modal.active { display: flex; }
</style>

<div class="container py-5">

    <% if (!sorun) { %>
        <div class="text-center py-5">
            <p style="color:hsl(var(--color-text-muted));">Sorun bulunamadı.</p>
            <a href="/sorunlar" class="btn btn-primary mt-3">Tüm sorunlara dön</a>
        </div>
    <% } else { %>

    <!-- BAŞLIK -->
    <div class="detail-header">
        <h1 class="detail-title"><%= sorun.baslik %></h1>
        <div class="detail-meta">Sorun ID: <%= sorun.id %> · <%= sorun.kategori %></div>
    </div>

    <!-- SORUN -->
    <div class="detail-card">
        <p class="detail-desc"><%= sorun.aciklama %></p>

        <% if (sorun.resim) { %>
            <div class="img-box" onclick="openModal('<%= sorun.resim %>')">
                <img src="<%= sorun.resim %>" alt="Sorun Görseli">
            </div>
        <% } %>
    </div>

    <!-- ÇÖZÜMLER -->
    <section>
        <h3 class="font-mono mb-3">Çözümler</h3>

        <% if (!cozumler || cozumler.length === 0) { %>
            <p class="solution-empty">Bu sorun için henüz bir çözüm paylaşılmamış.</p>
            <% if (session?.user) { %>
                <a href="/sorunlar/<%= sorun.slug || sorun._id %>/cozum-ekle" class="btn btn-primary">
                    İlk çözümü sen ekle
                </a>
            <% } else { %>
                <a href="/login" class="btn btn-primary">
                    Giriş yaparak çözüm ekle
                </a>
            <% } %>
        <% } else { %>

            <% cozumler.forEach(cozum => { %>
                <div class="solution-card">

                    <!-- Uzman rozeti: SADECE yazanRol === "uzman" ise göster -->
                    <% if (cozum.yazanRol === "uzman") { %>
                        <div class="expert-badge">✔ Uzman Çözümü</div>
                    <% } %>

                    <p><%= cozum.aciklama %></p>

                    <% if (cozum.resim) { %>
                        <div class="img-box" onclick="openModal('<%= cozum.resim %>')">
                            <img src="<%= cozum.resim %>" alt="Çözüm Görseli">
                        </div>
                    <% } %>

                    <!-- Çözümü yazan bilgisi -->
                    <div class="mt-3" style="font-size:0.85rem; color:hsl(var(--color-text-muted));">
                        Yazan: <strong style="color:hsl(var(--color-secondary));"><%= cozum.yazan || "Anonim" %></strong>
                        <% if (cozum.yazanRol === "uzman") { %>
                            <span class="badge bg-info text-dark ms-2" style="font-size:0.7rem;">Uzman</span>
                        <% } else if (cozum.yazanRol === "admin") { %>
                            <span class="badge bg-warning text-dark ms-2" style="font-size:0.7rem;">Admin</span>
                        <% } %>
                    </div>

                </div>
            <% }) %>
            <div class="solution-actions">
                <% if (session?.user) { %>
                    <a href="/sorunlar/<%= sorun.slug || sorun._id %>/cozum-ekle" class="btn btn-primary">
                        Yeni çözüm ekle
                    </a>
                <% } else { %>
                    <a href="/login" class="btn btn-primary">
                        Giriş yaparak çözüm ekle
                    </a>
                <% } %>
            </div>


        <% } %>
    </section>

    <a href="/sorunlar" class="back-link">← Tüm sorunlara geri dön</a>

    <% } %>
</div>

<!-- MODAL -->
<div class="img-modal" id="imgModal" onclick="closeModal()">
    <img id="modalImg">
</div>

<script>
    function openModal(src) {
        document.getElementById("modalImg").src = src;
        document.getElementById("imgModal").classList.add("active");
    }
    function closeModal() {
        document.getElementById("imgModal").classList.remove("active");
    }
</script>

<%- include("partials/footer") %>
